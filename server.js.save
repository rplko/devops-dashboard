const fs = require('fs');
const path = require('path');

const logFile = './logs/app.log';

function writeLog(message) {
    const time = new Date().toISOString();
    fs.appendFileSync(logFile, `[${time}] ${message}\n`);
}

const express = require('express');
const os = require('os');

const app = express();
const PORT = 3000;

// Serve static files (CSS, index.html)
app.use(express.static('public'));

// Routes for pages
app.get('/', (req, res) => {
writeLog("Home page visited");
res.sendFile(__dirname + '/public/index.html');
});

app.get('/about', (req, res) => {
writeLog("About page visited");
res.sendFile(__dirname + '/public/pages/about.html');
});

app.get('/projects', (req, res) => {
writeLog("Projects page visited");
    res.sendFile(__dirname + '/public/pages/projects.html');
});

app.get('/blog', (req, res) => {
writeLog("Blog page visited");
    res.sendFile(__dirname + '/public/pages/blog.html');
});

app.get('/contact', (req, res) => {
writeLog("Contact page visited");
    res.sendFile(__dirname + '/public/pages/contact.html');
});

app.get('/dashboard', (req, res) => {
writeLog("Dashboard page visited");
    res.sendFile(__dirname + '/public/pages/dashboard.html');
});

// Metrics API for dashboard
app.get('/metrics', (req, res) => {
    const os = require('os');

    const uptime = process.uptime();
    const memory = `${(process.memoryUsage().rss / 1024 / 1024).toFixed(2)} MB`;
    const cpu = os.loadavg()[0].toFixed(2);

    res.json({
        uptime: uptime.toFixed(0),
        memory,
        cpu,
        hostname: os.hostname(),
        platform: os.platform(),
        totalMem: (os.totalmem() / 1024 / 1024 / 1024).toFixed(2) + " GB",
        freeMem: (os.freemem() / 1024 / 1024 / 1024).toFixed(2) + " GB",
        nodeVersion: process.version
    });
});

app.get('/logs', (req, res) => {
    const logFile = path.join(__dirname, 'logs', 'app.log'); // logs/app.log

    fs.readFile('/log, 'utf8', (err, data) => {
        if (err) {
            return res.status(500).send("Log file not found.");
        }

        const lines = data.trim().split("\n");
        const last50 = lines.slice(-50).join("\n");

        res.send(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>App Logs | Rajat Pandey</title>
                <link rel="stylesheet" href="/css/style.css">
                <style>
                    pre {
                        background: #1e293b;
                        padding: 20px;
                        border-radius: 10px;
                        overflow-x: auto;
                        max-height: 600px;
                    }
                </style>
            </head>
            <body>
                <nav>
                    <a href="/">Home</a>
                    <a href="/about">About</a>
                    <a href="/projects">Projects</a>
                    <a href="/blog">Blog</a>
                    <a href="/dashboard">Dashboard</a>
                    <a href="/contact">Contact</a>
                    <a href="/logs">Logs</a>
                </nav>
                <div class="container">
                    <h1>Application Logs (last 50 lines)</h1>
                    <pre>${last50}</pre>
                </div>
            </body>
            </html>
        `);
    });
});


app.get('/api/logs', (req, res) => {
    fs.readFile('/app/logs/app.log', 'utf8', (err, data) => {
        if (err) {
            return res.send("No logs yet...");
        }
        res.send(data);
    });
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});
